<!DOCTYPE html>
<html lang="en" style="display: block!important;">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link href="https://fonts.googleapis.com/css?family=Press+Start+2P|Inconsolata:700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/unpoly@0.61.0/dist/unpoly.min.css" integrity="sha384-Au6LjS9fxDpwn3+26YmukmOumZUmryd8ONenkVIoH4eEPH1tACqLsVfqz9tBrvQy" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="blocks/cable-conntector.css">
  <link rel="stylesheet" href="blocks/channel.css">
  <link rel="stylesheet" href="blocks/display.css">
  <link rel="stylesheet" href="blocks/knob.css">

  <script src="https://unpkg.com/unpoly@0.61.0/dist/unpoly.min.js" integrity="sha384-gW6zzUz/Kx42R/cIyfZeFdlW18HuD/vtSCfsv6cdlfeg3CRqh89KzWER1dQ1i4BJ" crossorigin="anonymous"></script>
  <script src="compilers/cable-connector.js"></script>
  <script src="compilers/display.js"></script>
  <script src="compilers/knob.js"></script>
  <script src="compilers/power_switch.js"></script>
  <title>8 BIT reducer & mangler</title>
</head>

<body>

  <!--
    Ideas:
      * (optional) Controls for the bit depth
      * Visualization of the noise level per channel
  -->

  <div class="wrapper">
    <div class="machine-back">
      <div class="cable-connector -microphone">
        <div class="cable-connector--jack"></div>
        <div class="cable-connector--part -top"></div>
        <div class="cable-connector--part -center"></div>
        <div class="cable-connector--part -bottom"></div>
        <div class="cable-connector--label -label">Mic</div>
      </div>

      <div class="cable-connector -oscillator">
        <div class="cable-connector--jack"></div>
        <div class="cable-connector--part -top"></div>
        <div class="cable-connector--part -center"></div>
        <div class="cable-connector--part -bottom"></div>
        <div class="cable-connector--label -label">Osz</div>
      </div>

      <div class='upper-controls'>
        <input type="button" class="power-switch" value="â»" title="Start/Stop">
        <input type="button" class="input-visualizer" title='Current noise level'>
      </div>

      <div class="display">
        <span class="display--text" data-default-text="OTTO - 8 Bit Mangler"></span>
      </div>
      
      <div class='knobs'>
        <div class='knob -volume' data-initial-value='1'>
          <div class="knob--active-light"></div>
          <div class="knob--dial">
            <div class="knob--dial-grip"></div>
            <svg class="knob--dial-svg" viewBox="0 0 100 100">
              <path d="M20,76 A 40 40 0 1 1 80 76" fill="none" stroke="#55595C" />
              <path d="M20,76 A 40 40 0 1 1 80 76" fill="none" />
            </svg>
          </div>
          <div class="knob--label -label" title="Volume (Gain)">Vol</div>
        </div>
    
        <div class='knob -frequency-reduction' data-initial-value='0.5'>
          <div class="knob--active-light"></div>
          <div class="knob--dial">
            <div class="knob--dial-grip"></div>
            <svg class="knob--dial-svg" viewBox="0 0 100 100">
              <path d="M20,76 A 40 40 0 1 1 80 76" fill="none" stroke="#55595C" />
              <path d="M20,76 A 40 40 0 1 1 80 76" fill="none" />
            </svg>
          </div>
          <div class="knob--label -label" title="Frequency Reduction">Freq</div>
        </div>
      </div>

      <div class="channels-container">
        <div class="channel">
            <input type="button" class="channel--button -active" id="0">
            <div class="channel--labels -label">
                <label>1</label>
                <label>TAP</label>
            </div>
        </div>
        <div class="channel">
          <input type="button" class="channel--button -active" id="1">
            <div class="channel--labels -label">
                <label>2</label>
                <label>-/F1</label>
            </div>
        </div>
        <div class="channel">
          <input type="button" class="channel--button -active" id="2">
            <div class="channel--labels -label">
                <label>3</label>
                <label>+/F2</label>
            </div>
        </div>
        <div class="channel">
          <input type="button" class="channel--button -active" id="3">
            <div class="channel--labels -label">
                <label>4</label>
                <label>F3</label>
            </div>
        </div>
        <div class="channel">
          <input type="button" class="channel--button -active" id="4">
            <div class="channel--labels -label">
                <label>5</label>
                <label>Wave</label>
            </div>
        </div>
        <div class="channel">
          <input type="button" class="channel--button -active" id="5">
            <div class="channel--labels -label">
                <label>6</label>
                <label>Delay</label>
            </div>
        </div>
        <div class="channel">
          <input type="button" class="channel--button -active" id="6">
            <div class="channel--labels -label">
                <label>7</label>
                <label>Pitch</label>
            </div>
        </div>
        <div class="channel">
          <input type="button" class="channel--button -active" id="7">
            <div class="channel--labels -label">
                <label>8</label>
                <label>Step</label>
            </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    const buttonStates = ["0", "-1", "1"]
    const processAudio = async () => {
      const audioContext = new AudioContext();
      // Initialize the audio context and its processor
      await audioContext.audioWorklet.addModule('bit-crusher-processor.js');
      const inputStreamSignal = await setupInputStream(audioContext);
      const inputGain = setupGain(audioContext); // Formerly: microphoneGain, now indifferent about microphone and oscillator
      
      const bitCrusher = new AudioWorkletNode(audioContext, 'bit-crusher-processor');
      const paramBitDepth = bitCrusher.parameters.get('bitDepth');
      const paramReduction = bitCrusher.parameters.get('frequencyReduction');

      const analyser = setupAnalyser(audioContext);
      inputGain.connect(analyser);
      
      inputStreamSignal
        .connect(inputGain)
        .connect(bitCrusher)
        .connect(audioContext.destination);

      function onVolumeChange(evt){
        const newVolume = evt.target.getValue();
        inputGain.gain.setValueAtTime(newVolume, audioContext.currentTime);
        up.emit('status-text-changed', {text: `Volume: ${ parseInt(newVolume * 100) }%`, instant: true});
      };
      
      function mute(){
        inputGain.gain.setValueAtTime(0, audioContext.currentTime);
      }
    
      function unmute(){
        inputGain.gain.setValueAtTime(1, audioContext.currentTime);
      }
    
      function onFrequencyReductionChange(evt){
        // |frequencyReduction| parameters will be automated and changing over
        // time. Thus its parameter array will have 128 values.
        //paramReduction.setValueAtTime(0.01, 0);
        //paramReduction.linearRampToValueAtTime(0.1, 4);
        //paramReduction.exponentialRampToValueAtTime(0.01, 8);
        const newFrequencyReduction = evt.target.getValue();
        paramReduction.setValueAtTime(newFrequencyReduction, audioContext.currentTime);
        up.emit('status-text-changed', {text: `Frequency Reduction: ${ parseInt(newFrequencyReduction * 100) }%`, instant: true});
      };

      function changeChannelState(evt) {
        let element = evt.target;
        let channelNumber = parseInt(element.id);
        let statusChangeName;
        switch (true) {
          case element.classList.contains('-active'):
            element.classList.remove('-active');
            element.classList.add('-inverted');
            bitCrusher.port.postMessage([channelNumber, -1]);
            statusChangeName = 'inverted';
            break;
          case element.classList.contains('-inverted'):
            element.classList.remove('-inverted');
            element.classList.add('-inactive');
            bitCrusher.port.postMessage([channelNumber, 0]);
            statusChangeName = 'disabled';
            break;
          case element.classList.contains('-inactive'):
            element.classList.remove('-inactive');
            element.classList.add('-active');
            bitCrusher.port.postMessage([channelNumber, 1]);
            statusChangeName = 'enabled';
            break;
        };
        up.emit('status-text-changed', {text: `Channel ${ channelNumber + 1 } ${statusChangeName}`, instant: true});
      };

      up.on('reset:off', function(){
        audioContext.suspend();
        mute();
      });
      up.on('reset:on', function(){
        audioContext.resume();
        unmute();
      });
      up.on('button-value-changed', '.knob.-volume', onVolumeChange)
      up.on('button-value-changed', '.knob.-frequency-reduction', onFrequencyReductionChange)
      up.on('click', '.channel--button', changeChannelState);
      up.emit('reset:on');
    };

    up.on('power:on', processAudio);

    function setupAnalyser(audioContext){
      let analyser = audioContext.createAnalyser();
      analyser.fftSize = 32;
      analyser.minDecibels = -90;
      
      // Visualize the current noise level (updated 5 times per second)
      setInterval(function () {
        let dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        document.querySelector(".input-visualizer").style.backgroundColor = "hsla(50, 100%, " + dataArray[3] / 2 + 20 + "%, 1)";
      }, 200);
      return analyser;
    }
    
    function setupGain(audioContext){
      let inputGain = audioContext.createGain();
      up.on('reset:on', function(){
        // Initial volume: 100%
        inputGain.gain.setValueAtTime(1, audioContext.currentTime);
      })
      return inputGain;
    }

    async function setupInputStream(audioContext){
      try {
        return await setupMicrophoneStream(audioContext);
      } catch  (err) {
        return setupOscillatorStream(audioContext);
      }
    }

    async function setupMicrophoneStream(audioContext){
      let microphoneAudioInput = await getMicrophoneAudioInput();
      let microphoneInAudioContext = audioContext.createMediaStreamSource(microphoneAudioInput);

      up.on('reset:on', function(){
        up.emit('plug-in', { target: document.querySelector('.cable-connector.-microphone') });
      });
      return microphoneInAudioContext;
    }

    // Ask for user permission to the microphone audio stream
    async function getMicrophoneAudioInput() {
      return await navigator.mediaDevices.getUserMedia({ audio: true });
    }

    function setupOscillatorStream(audioContext){
      const oscillator = new OscillatorNode(audioContext);
      oscillator.type = 'sine';
      let baseFrequency = 440; // hertz
      oscillator.frequency.setValueAtTime(baseFrequency, audioContext.currentTime);
      oscillator.start();

      setInterval(function(){
        let offset = Math.random() * 400 - 200;
        oscillator.frequency.exponentialRampToValueAtTime(baseFrequency + offset, audioContext.currentTime + 0.75);
        baseFrequency += 200;
        if(baseFrequency > 800){
          baseFrequency = 420;
        }
      }, 2000)
      
      up.on('reset:on', function(){
        up.emit('plug-in', { target: document.querySelector('.cable-connector.-oscillator') });
      });
    
      return oscillator;
    }

  </script>
</body>

</html>